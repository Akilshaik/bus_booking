{% extends "base.html" %}
{% load static %}
{% block title %}Select Seats{% endblock %}

{% block extra_head %}

<style>
  /* =========================
     Dark Premium Seat UI
     ========================= */

  .seat-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(44px, 1fr));
    gap: 10px;
  }

  .seat-item { position: relative; }

  /* Base seat look (glass button) */
  .seat-btn{
    width: 100%;
    height: 44px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 10px 24px rgba(0,0,0,.28);
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    user-select: none;
    cursor: pointer;
  }

  .seat-btn:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.10);
    border-color: rgba(255,255,255,.24);
  }

  /* Since you're using input + label, style selection via :checked + label */
  .seat-check:checked + label.seat-btn{
    background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.85));
    border-color: rgba(147,197,253,.55);
    color: #fff;
    box-shadow: 0 16px 32px rgba(59,130,246,.18);
  }

  /* Unavailable seats */
  .seat-btn.unavailable{
    background: rgba(255,255,255,.04);
    color: rgba(229,231,235,.45);
    border-color: rgba(255,255,255,.10);
    cursor: not-allowed;
    box-shadow: none;
    opacity: .85;
  }

  /* Legend dots match theme */
  .legend-dot{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    vertical-align: middle;
  }

  /* Make legend "Available" dot fit dark UI */
  .legend-available{
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.18);
  }
  .legend-selected{
    background: #3b82f6;
  }
  .legend-unavailable{
    background: rgba(255,255,255,.12);
  }

  /* Small text readability on dark */
  .text-muted{ color: rgba(229,231,235,.70) !important; }

  /* Ensure border-top line is visible */
  .border-top{
    border-top: 1px solid rgba(255,255,255,.12) !important;
  }
</style>

{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-1">Select Seats</h4>
        <div class="text-muted small mb-3">
          {{ trip.route.source }} → {{ trip.route.destination }} • {{ trip.journey_date }} • {{ trip.departure_time }} - {{ trip.arrival_time }}
        </div>

        {% if error %}
          <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <div class="d-flex gap-3 small mb-3">
          <div><span class="legend-dot" style="background:#fff;border:1px solid #ced4da;"></span>Available</div>
          <div><span class="legend-dot" style="background:#0d6efd;"></span>Selected</div>
          <div><span class="legend-dot" style="background:#e9ecef;"></span>Booked/Locked</div>
        </div>

        <form method="post" id="seatForm">
          {% csrf_token %}

          <input type="hidden" id="baseFare" value="{{ trip.base_fare }}">
          <input type="hidden" name="trip_id" value="{{ trip.id }}">

          <div class="mb-3">
            <h6 class="mb-2">Seats</h6>
            <div class="seat-grid">
              {% for seat in seats %}
                <div class="seat-item">
                  {% if seat.id in unavailable_ids %}
                    <button type="button" class="seat-btn unavailable" disabled title="Unavailable">{{ seat.seat_number }}</button>
                  {% else %}
                    <input class="d-none seat-check" type="checkbox" name="seats" value="{{ seat.id }}"
                           id="seat{{ seat.id }}" data-seat-number="{{ seat.seat_number }}">
                    <label class="seat-btn d-flex align-items-center justify-content-center"
                           for="seat{{ seat.id }}">{{ seat.seat_number }}</label>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <div class="text-muted small mt-2">Tip: select 1 or more seats and continue.</div>
          </div>

          <div class="d-flex justify-content-between align-items-center border-top pt-3">
            <div>
              <div class="small text-muted">Selected Seats:</div>
              <div class="fw-semibold" id="selectedSeatsText">None</div>
            </div>

            <div class="text-end">
              <div class="small text-muted">Total Fare</div>
              <div class="fs-5 fw-bold">₹<span id="totalFare">0</span></div>
              <button class="btn btn-primary mt-2" type="submit">Continue</button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4 mt-3 mt-lg-0">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Trip Details</h6>
        <div class="small">
          <div><b>Bus:</b> {{ trip.bus.operator_name }}</div>
          <div><b>Type:</b> {{ trip.bus.get_bus_type_display }}</div>
          <div><b>Date:</b> {{ trip.journey_date }}</div>
          <div><b>Time:</b> {{ trip.departure_time }} - {{ trip.arrival_time }}</div>
          <div class="mt-2"><b>Base Fare/Seat:</b> ₹{{ trip.base_fare }}</div>
          <div class="text-muted mt-2">Seats are held temporarily during checkout.</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/seat.js' %}"></script>
{% endblock %}